<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Video → Frame-by-frame Export + Flipbook</title>
  <style>
    body{font-family:Arial, sans-serif;background:#0f1724;color:#fff;margin:0;padding:20px}
    h1{font-size:20px;margin-bottom:10px}
    .btn{background:#06b6d4;color:#000;border:0;padding:8px 12px;margin:5px;cursor:pointer;border-radius:6px}
    .thumb{width:96px;height:72px;object-fit:cover;margin:4px;border-radius:4px}
    .gallery{display:flex;flex-wrap:wrap;max-height:300px;overflow:auto;background:#111;padding:6px;border-radius:6px}
    #bigPreview img{max-width:100%;max-height:400px;border-radius:6px}
    .controls{margin-bottom:10px}
  </style>
</head>
<body>
  <h1>Video → Frames + Flipbook</h1>
  <div class="controls">
    <input id="file" type="file" accept="video/*" />
    <input id="fps" type="number" value="10" min="1" max="60" /> FPS
    <button id="extract" class="btn">Extract Frames</button>
    <button id="clear" class="btn">Clear</button>
    <button id="downloadZip" class="btn" disabled>Download All</button>
  </div>
  <p id="status">No video loaded.</p>
  <div id="gallery" class="gallery"></div>
  <div id="bigPreview"></div>
  <div>
    <button id="play" class="btn" disabled>Play</button>
    <button id="pause" class="btn" disabled>Pause</button>
    <label>Speed:</label>
    <input id="playFps" type="range" min="1" max="60" value="12" />
    <span id="playerInfo">Frames: 0 • Index: 0</span>
  </div>

  <video id="video" crossorigin="anonymous" style="display:none"></video>
  <canvas id="canvas" style="display:none"></canvas>

  <script>
    const fileEl = document.getElementById('file');
    const fpsEl = document.getElementById('fps');
    const extractBtn = document.getElementById('extract');
    const gallery = document.getElementById('gallery');
    const statusEl = document.getElementById('status');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const clearBtn = document.getElementById('clear');
    const downloadZipBtn = document.getElementById('downloadZip');
    const playBtn = document.getElementById('play');
    const pauseBtn = document.getElementById('pause');
    const playFps = document.getElementById('playFps');
    const bigPreview = document.getElementById('bigPreview');
    const playerInfo = document.getElementById('playerInfo');

    let frames = [];
    let extracting = false;
    let playerTimer = null;
    let currentIndex = 0;

    function setStatus(t){ statusEl.textContent = t; }

    fileEl.addEventListener('change', async (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      video.src = url;
      await video.load();
      video.addEventListener('loadedmetadata', ()=>{
        setStatus(`Duration: ${video.duration.toFixed(2)}s • ${video.videoWidth}×${video.videoHeight}`);
      }, {once:true});
    });

    clearBtn.addEventListener('click', ()=>{
      frames.forEach(fr=>URL.revokeObjectURL(fr.url));
      frames = [];
      gallery.innerHTML = '';
      bigPreview.innerHTML = '';
      downloadZipBtn.disabled = true;
      playBtn.disabled = true;
      pauseBtn.disabled = true;
      updatePlayerInfo();
    });

    extractBtn.addEventListener('click', async ()=>{
      if(!video.src){ setStatus('Please load a video first.'); return; }
      if(extracting) return;
      frames = [];
      gallery.innerHTML = '';
      extracting = true;
      extractBtn.disabled = true;
      const fps = Number(fpsEl.value) || 10;
      const duration = video.duration;
      const step = 1 / fps;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      let count = 0;
      for(let t=0; t<duration; t+=step){
        await seekVideoTo(t);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        await saveCanvasBlob(count);
        count++;
        setStatus(`Extracted ${count} frames`);
        await new Promise(r=>setTimeout(r,0));
      }
      setStatus(`Done — ${frames.length} frames extracted`);
      downloadZipBtn.disabled = false;
      playBtn.disabled = false;
      pauseBtn.disabled = false;
      extracting = false;
      extractBtn.disabled = false;
    });

    function seekVideoTo(time){
      return new Promise((resolve)=>{
        function onSeeked(){
          video.removeEventListener('seeked', onSeeked);
          resolve();
        }
        video.addEventListener('seeked', onSeeked);
        video.currentTime = Math.min(time, video.duration);
      });
    }

    async function saveCanvasBlob(index){
      return new Promise((resolve)=>{
        canvas.toBlob((blob)=>{
          const url = URL.createObjectURL(blob);
          frames.push({blob,url,name:`frame_${String(index).padStart(5,'0')}.png`});
          const img=document.createElement('img');
          img.src=url;img.className='thumb';img.title=`Frame ${index}`;
          img.onclick=()=>showFrame(index);
          gallery.appendChild(img);
          if(frames.length===1) showFrame(0);
          resolve();
        },'image/png');
      });
    }

    function showFrame(i){
      if(!frames[i]) return;
      currentIndex=i;
      bigPreview.innerHTML='';
      const im=document.createElement('img');
      im.src=frames[i].url;
      bigPreview.appendChild(im);
      updatePlayerInfo();
    }

    // Download all frames without external library
    downloadZipBtn.addEventListener('click', ()=>{
      if(frames.length===0) return;
      frames.forEach((f,i)=>{
        const a=document.createElement('a');
        a.href=f.url;
        a.download=f.name;
        a.click();
      });
    });

    playBtn.addEventListener('click', ()=>{
      if(frames.length===0) return;
      const fps=Number(playFps.value)||12;
      const interval=1000/fps;
      if(playerTimer) clearInterval(playerTimer);
      playerTimer=setInterval(()=>{
        showFrame((currentIndex+1)%frames.length);
      },interval);
    });
    pauseBtn.addEventListener('click', ()=>{
      if(playerTimer) clearInterval(playerTimer);
      playerTimer=null;
    });
    playFps.addEventListener('input', ()=>{
      if(playerTimer){clearInterval(playerTimer);
        const fps=Number(playFps.value)||12;
        playerTimer=setInterval(()=>{
          showFrame((currentIndex+1)%frames.length);
        },1000/fps);
      }
    });

    function updatePlayerInfo(){
      playerInfo.textContent=`Frames: ${frames.length} • Index: ${currentIndex}`;
    }
  </script>
</body>
</html>
