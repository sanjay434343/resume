<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advanced Video Frame Extractor</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a0e1a 0%, #1a1f36 100%);
      color: #e2e8f0;
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(30, 41, 59, 0.4);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(71, 85, 105, 0.3);
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(45deg, #06b6d4, #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
    }

    .header p {
      color: #94a3b8;
      font-size: 1.1rem;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: rgba(30, 41, 59, 0.6);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(71, 85, 105, 0.3);
      backdrop-filter: blur(10px);
    }

    .panel h2 {
      color: #06b6d4;
      font-size: 1.4rem;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-group {
      margin-bottom: 16px;
    }

    .control-group label {
      display: block;
      margin-bottom: 6px;
      color: #cbd5e1;
      font-weight: 500;
    }

    .input-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      background: linear-gradient(45deg, #06b6d4, #0891b2);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-height: 40px;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn.secondary {
      background: linear-gradient(45deg, #475569, #64748b);
    }

    .btn.danger {
      background: linear-gradient(45deg, #ef4444, #dc2626);
    }

    .btn.success {
      background: linear-gradient(45deg, #10b981, #059669);
    }

    input[type="file"] {
      background: rgba(71, 85, 105, 0.3);
      border: 2px dashed #475569;
      border-radius: 8px;
      padding: 12px;
      color: #e2e8f0;
      width: 100%;
      cursor: pointer;
      transition: all 0.2s;
    }

    input[type="file"]:hover {
      border-color: #06b6d4;
      background: rgba(6, 182, 212, 0.1);
    }

    input[type="number"], input[type="range"], select {
      background: rgba(71, 85, 105, 0.4);
      border: 1px solid #475569;
      border-radius: 6px;
      padding: 8px 12px;
      color: #e2e8f0;
      font-size: 14px;
      min-height: 36px;
    }

    input[type="number"]:focus, select:focus {
      outline: none;
      border-color: #06b6d4;
      box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
    }

    .range-container {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
    }

    .range-value {
      background: #06b6d4;
      color: #0f172a;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 600;
      min-width: 40px;
      text-align: center;
      font-size: 12px;
    }

    input[type="range"] {
      flex: 1;
      height: 6px;
      background: #475569;
      border-radius: 3px;
      outline: none;
      padding: 0;
    }

    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #06b6d4;
      cursor: pointer;
      border: 2px solid #0f172a;
    }

    .status {
      background: rgba(71, 85, 105, 0.4);
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      border-left: 4px solid #06b6d4;
      font-family: 'Courier New', monospace;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(71, 85, 105, 0.4);
      border-radius: 4px;
      overflow: hidden;
      margin: 12px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #06b6d4, #3b82f6);
      width: 0%;
      transition: width 0.2s;
    }

    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
      background: rgba(15, 23, 42, 0.6);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid rgba(71, 85, 105, 0.3);
      scrollbar-width: thin;
      scrollbar-color: #06b6d4 rgba(71, 85, 105, 0.3);
    }

    .gallery::-webkit-scrollbar {
      width: 8px;
    }

    .gallery::-webkit-scrollbar-track {
      background: rgba(71, 85, 105, 0.3);
      border-radius: 4px;
    }

    .gallery::-webkit-scrollbar-thumb {
      background: #06b6d4;
      border-radius: 4px;
    }

    .thumb {
      width: 100%;
      aspect-ratio: 16/9;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .thumb:hover {
      transform: scale(1.05);
      border-color: #06b6d4;
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
    }

    .thumb.active {
      border-color: #06b6d4;
      box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.4);
    }

    .preview-container {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      min-height: 300px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border: 1px solid rgba(71, 85, 105, 0.3);
    }

    .preview-container img {
      max-width: 100%;
      max-height: 400px;
      border-radius: 8px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .preview-placeholder {
      color: #64748b;
      font-size: 1.1rem;
      text-align: center;
    }

    .player-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    .frame-info {
      background: rgba(71, 85, 105, 0.4);
      padding: 8px 12px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #06b6d4;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-item {
      background: rgba(71, 85, 105, 0.4);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #06b6d4;
      display: block;
    }

    .stat-label {
      font-size: 0.85rem;
      color: #94a3b8;
    }

    .format-selector {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .quality-slider {
      width: 100%;
    }

    .extraction-settings {
      background: rgba(71, 85, 105, 0.2);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 8px 0;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #06b6d4;
    }

    .time-input {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .time-input input {
      width: 80px;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .extracting {
      animation: pulse 2s infinite;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s;
    }

    .toast.show {
      transform: translateX(0);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üé¨ Advanced Video Frame Extractor</h1>
      <p>Extract, preview, and download video frames with precision control</p>
    </div>

    <div class="main-grid">
      <!-- Left Panel - Controls -->
      <div class="panel">
        <h2>üìÅ Video Input</h2>
        <div class="control-group">
          <label>Select Video File</label>
          <input id="file" type="file" accept="video/*" />
        </div>

        <div class="stats-grid" id="videoStats" style="display:none;">
          <div class="stat-item">
            <span class="stat-value" id="durationStat">0s</span>
            <span class="stat-label">Duration</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="resolutionStat">0√ó0</span>
            <span class="stat-label">Resolution</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="sizeStat">0 MB</span>
            <span class="stat-label">File Size</span>
          </div>
        </div>

        <div class="extraction-settings">
          <h3 style="color: #06b6d4; margin-bottom: 12px;">‚öôÔ∏è Extraction Settings</h3>
          
          <div class="control-group">
            <label>Extraction FPS</label>
            <div class="range-container">
              <input id="fps" type="range" min="1" max="60" value="10" />
              <span class="range-value" id="fpsValue">10</span>
            </div>
          </div>

          <div class="control-group">
            <label>Time Range</label>
            <div class="checkbox-group">
              <input type="checkbox" id="useTimeRange" />
              <label for="useTimeRange">Extract specific time range</label>
            </div>
            <div class="time-input" id="timeRangeInputs" style="display:none;">
              <input type="number" id="startTime" placeholder="Start" step="0.1" min="0" />
              <span>to</span>
              <input type="number" id="endTime" placeholder="End" step="0.1" min="0" />
              <span>seconds</span>
            </div>
          </div>

          <div class="control-group">
            <label>Output Format</label>
            <div class="format-selector">
              <select id="outputFormat">
                <option value="png">PNG (Best Quality)</option>
                <option value="jpg">JPEG (Smaller Size)</option>
                <option value="webp">WebP (Modern)</option>
              </select>
            </div>
          </div>

          <div class="control-group">
            <label>JPEG Quality (if applicable)</label>
            <div class="range-container">
              <input id="quality" type="range" min="10" max="100" value="90" class="quality-slider" />
              <span class="range-value" id="qualityValue">90%</span>
            </div>
          </div>

          <div class="control-group">
            <label>Scale Factor</label>
            <div class="range-container">
              <input id="scaleFactor" type="range" min="0.25" max="2" step="0.25" value="1" />
              <span class="range-value" id="scaleValue">1x</span>
            </div>
          </div>
        </div>

        <div class="input-row">
          <button id="extract" class="btn">üöÄ Extract Frames</button>
          <button id="clear" class="btn danger">üóëÔ∏è Clear All</button>
        </div>

        <div class="status" id="status">Ready to extract frames from your video</div>
        <div class="progress-bar" id="progressContainer" style="display:none;">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>

      <!-- Right Panel - Preview -->
      <div class="panel">
        <h2>üñºÔ∏è Frame Preview</h2>
        <div class="preview-container" id="bigPreview">
          <div class="preview-placeholder">
            <div style="font-size: 3rem; margin-bottom: 16px;">üìΩÔ∏è</div>
            <div>Frame preview will appear here</div>
          </div>
        </div>

        <div class="player-controls">
          <button id="prevFrame" class="btn secondary">‚èÆÔ∏è Prev</button>
          <button id="play" class="btn" disabled>‚ñ∂Ô∏è Play</button>
          <button id="pause" class="btn secondary" disabled>‚è∏Ô∏è Pause</button>
          <button id="nextFrame" class="btn secondary">‚è≠Ô∏è Next</button>
        </div>

        <div class="control-group">
          <label>Playback Speed</label>
          <div class="range-container">
            <input id="playFps" type="range" min="1" max="60" value="12" />
            <span class="range-value" id="playFpsValue">12 FPS</span>
          </div>
        </div>

        <div class="frame-info" id="playerInfo">
          Frames: 0 ‚Ä¢ Index: 0 ‚Ä¢ Time: 0.00s
        </div>
      </div>
    </div>

    <!-- Gallery Section -->
    <div class="panel">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2>üéûÔ∏è Frame Gallery</h2>
        <div style="display: flex; gap: 12px;">
          <button id="selectAll" class="btn secondary">‚úÖ Select All</button>
          <button id="selectNone" class="btn secondary">‚ùå Select None</button>
          <button id="downloadSelected" class="btn success" disabled>üì• Download Selected</button>
          <button id="downloadZip" class="btn" disabled>üì¶ Download All ZIP</button>
        </div>
      </div>
      <div class="gallery" id="gallery"></div>
    </div>
  </div>

  <video id="video" crossorigin="anonymous" style="display:none"></video>
  <canvas id="canvas" style="display:none"></canvas>

  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    // DOM Elements
    const fileEl = document.getElementById('file');
    const fpsEl = document.getElementById('fps');
    const fpsValue = document.getElementById('fpsValue');
    const extractBtn = document.getElementById('extract');
    const gallery = document.getElementById('gallery');
    const statusEl = document.getElementById('status');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const clearBtn = document.getElementById('clear');
    const downloadZipBtn = document.getElementById('downloadZip');
    const playBtn = document.getElementById('play');
    const pauseBtn = document.getElementById('pause');
    const playFps = document.getElementById('playFps');
    const playFpsValue = document.getElementById('playFpsValue');
    const bigPreview = document.getElementById('bigPreview');
    const playerInfo = document.getElementById('playerInfo');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    
    // New elements
    const videoStats = document.getElementById('videoStats');
    const durationStat = document.getElementById('durationStat');
    const resolutionStat = document.getElementById('resolutionStat');
    const sizeStat = document.getElementById('sizeStat');
    const useTimeRange = document.getElementById('useTimeRange');
    const timeRangeInputs = document.getElementById('timeRangeInputs');
    const startTime = document.getElementById('startTime');
    const endTime = document.getElementById('endTime');
    const outputFormat = document.getElementById('outputFormat');
    const quality = document.getElementById('quality');
    const qualityValue = document.getElementById('qualityValue');
    const scaleFactor = document.getElementById('scaleFactor');
    const scaleValue = document.getElementById('scaleValue');
    const prevFrame = document.getElementById('prevFrame');
    const nextFrame = document.getElementById('nextFrame');
    const selectAll = document.getElementById('selectAll');
    const selectNone = document.getElementById('selectNone');
    const downloadSelected = document.getElementById('downloadSelected');

    // State
    let frames = [];
    let selectedFrames = new Set();
    let extracting = false;
    let playerTimer = null;
    let currentIndex = 0;
    let videoFile = null;

    // Event Listeners
    fpsEl.addEventListener('input', () => {
      fpsValue.textContent = fpsEl.value;
    });

    playFps.addEventListener('input', () => {
      playFpsValue.textContent = playFps.value + ' FPS';
      if (playerTimer) {
        pausePlayer();
        startPlayer();
      }
    });

    quality.addEventListener('input', () => {
      qualityValue.textContent = quality.value + '%';
    });

    scaleFactor.addEventListener('input', () => {
      scaleValue.textContent = scaleFactor.value + 'x';
    });

    useTimeRange.addEventListener('change', () => {
      timeRangeInputs.style.display = useTimeRange.checked ? 'flex' : 'none';
    });

    fileEl.addEventListener('change', async (e) => {
      const f = e.target.files[0];
      if (!f) return;
      
      videoFile = f;
      const url = URL.createObjectURL(f);
      video.src = url;
      
      video.addEventListener('loadedmetadata', () => {
        const duration = video.duration;
        const width = video.videoWidth;
        const height = video.videoHeight;
        const sizeM = (f.size / (1024 * 1024)).toFixed(1);
        
        durationStat.textContent = duration.toFixed(1) + 's';
        resolutionStat.textContent = `${width}√ó${height}`;
        sizeStat.textContent = sizeM + ' MB';
        videoStats.style.display = 'grid';
        
        endTime.value = duration.toFixed(1);
        endTime.max = duration;
        startTime.max = duration;
        
        setStatus(`Video loaded: ${duration.toFixed(1)}s ‚Ä¢ ${width}√ó${height} ‚Ä¢ ${sizeM}MB`);
      }, { once: true });
    });

    clearBtn.addEventListener('click', () => {
      frames.forEach(fr => URL.revokeObjectURL(fr.url));
      frames = [];
      selectedFrames.clear();
      gallery.innerHTML = '';
      bigPreview.innerHTML = '<div class="preview-placeholder"><div style="font-size: 3rem; margin-bottom: 16px;">üìΩÔ∏è</div><div>Frame preview will appear here</div></div>';
      downloadZipBtn.disabled = true;
      downloadSelected.disabled = true;
      playBtn.disabled = true;
      pauseBtn.disabled = true;
      updatePlayerInfo();
      setStatus('All frames cleared');
      progressContainer.style.display = 'none';
    });

    extractBtn.addEventListener('click', async () => {
      if (!video.src) {
        setStatus('Please load a video first.');
        return;
      }
      if (extracting) return;
      
      await extractFrames();
    });

    async function extractFrames() {
      frames = [];
      selectedFrames.clear();
      gallery.innerHTML = '';
      extracting = true;
      extractBtn.disabled = true;
      extractBtn.classList.add('extracting');
      progressContainer.style.display = 'block';
      
      const fps = Number(fpsEl.value) || 10;
      const duration = video.duration;
      const startT = useTimeRange.checked ? (Number(startTime.value) || 0) : 0;
      const endT = useTimeRange.checked ? (Number(endTime.value) || duration) : duration;
      const step = 1 / fps;
      const format = outputFormat.value;
      const qualityVal = quality.value / 100;
      const scale = Number(scaleFactor.value);
      
      canvas.width = video.videoWidth * scale;
      canvas.height = video.videoHeight * scale;
      
      let count = 0;
      const totalFrames = Math.ceil((endT - startT) * fps);
      
      for (let t = startT; t < endT; t += step) {
        await seekVideoTo(t);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        await saveCanvasBlob(count, t, format, qualityVal);
        count++;
        
        const progress = (count / totalFrames) * 100;
        progressFill.style.width = progress + '%';
        setStatus(`Extracting frames: ${count}/${totalFrames} (${progress.toFixed(1)}%)`);
        
        await new Promise(r => setTimeout(r, 0));
      }
      
      setStatus(`‚úÖ Extraction complete! ${frames.length} frames extracted`);
      downloadZipBtn.disabled = false;
      playBtn.disabled = false;
      pauseBtn.disabled = false;
      extracting = false;
      extractBtn.disabled = false;
      extractBtn.classList.remove('extracting');
      progressContainer.style.display = 'none';
      showToast('Frames extracted successfully!');
    }

    function seekVideoTo(time) {
      return new Promise((resolve) => {
        function onSeeked() {
          video.removeEventListener('seeked', onSeeked);
          resolve();
        }
        video.addEventListener('seeked', onSeeked);
        video.currentTime = Math.min(time, video.duration);
      });
    }

    async function saveCanvasBlob(index, timestamp, format, qualityVal) {
      return new Promise((resolve) => {
        const mimeType = format === 'jpg' ? 'image/jpeg' : `image/${format}`;
        const filename = `frame_${String(index).padStart(5, '0')}.${format}`;
        
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          frames.push({ 
            blob, 
            url, 
            name: filename, 
            timestamp, 
            index,
            selected: false 
          });
          
          const container = document.createElement('div');
          container.style.position = 'relative';
          
          const img = document.createElement('img');
          img.src = url;
          img.className = 'thumb';
          img.title = `Frame ${index} ‚Ä¢ ${timestamp.toFixed(2)}s`;
          img.onclick = () => showFrame(index);
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.style.position = 'absolute';
          checkbox.style.top = '4px';
          checkbox.style.left = '4px';
          checkbox.style.zIndex = '10';
          checkbox.style.width = '16px';
          checkbox.style.height = '16px';
          checkbox.onchange = (e) => toggleFrameSelection(index, e.target.checked);
          
          container.appendChild(img);
          container.appendChild(checkbox);
          gallery.appendChild(container);
          
          if (frames.length === 1) showFrame(0);
          resolve();
        }, mimeType, format === 'jpg' ? qualityVal : undefined);
      });
    }

    function toggleFrameSelection(index, selected) {
      if (selected) {
        selectedFrames.add(index);
      } else {
        selectedFrames.delete(index);
      }
      downloadSelected.disabled = selectedFrames.size === 0;
    }

    function showFrame(i) {
      if (!frames[i]) return;
      
      // Update active thumbnail
      document.querySelectorAll('.thumb').forEach((thumb, idx) => {
        thumb.classList.toggle('active', idx === i);
      });
      
      currentIndex = i;
      bigPreview.innerHTML = '';
      const im = document.createElement('img');
      im.src = frames[i].url;
      bigPreview.appendChild(im);
      updatePlayerInfo();
    }

    // Player controls
    playBtn.addEventListener('click', startPlayer);
    pauseBtn.addEventListener('click', pausePlayer);
    
    prevFrame.addEventListener('click', () => {
      if (frames.length === 0) return;
      const newIndex = currentIndex > 0 ? currentIndex - 1 : frames.length - 1;
      showFrame(newIndex);
    });
    
    nextFrame.addEventListener('click', () => {
      if (frames.length === 0) return;
      const newIndex = (currentIndex + 1) % frames.length;
      showFrame(newIndex);
    });

    function startPlayer() {
      if (frames.length === 0) return;
      const fps = Number(playFps.value) || 12;
      const interval = 1000 / fps;
      
      if (playerTimer) clearInterval(playerTimer);
      playerTimer = setInterval(() => {
        showFrame((currentIndex + 1) % frames.length);
      }, interval);
    }

    function pausePlayer() {
      if (playerTimer) {
        clearInterval(playerTimer);
        playerTimer = null;
      }
    }

    // Selection controls
    selectAll.addEventListener('click', () => {
      selectedFrames.clear();
      document.querySelectorAll('input[type="checkbox"]').forEach((cb, idx) => {
        cb.checked = true;
        selectedFrames.add(idx);
      });
      downloadSelected.disabled = false;
    });

    selectNone.addEventListener('click', () => {
      selectedFrames.clear();
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
      });
      downloadSelected.disabled = true;
    });

    // Download functions
    downloadZipBtn.addEventListener('click', async () => {
      if (frames.length === 0) return;
      await downloadFramesAsZip(frames, 'all_frames.zip');
    });

    downloadSelected.addEventListener('click', async () => {
      if (selectedFrames.size === 0) return;
      const selected = frames.filter((_, idx) => selectedFrames.has(idx));
      await downloadFramesAsZip(selected, 'selected_frames.zip');
    });

    async function downloadFramesAsZip(framesToDownload, filename) {
      if (framesToDownload.length === 0) return;
      
      setStatus('Preparing ZIP archive...');
      const zip = new JSZip();
      const folder = zip.folder('frames');
      
      for (let i = 0; i < framesToDownload.length; i++) {
        const frame = framesToDownload[i];
        const arrayBuffer = await frame.blob.arrayBuffer();
        folder.file(frame.name, arrayBuffer);
        
        const progress = ((i + 1) / framesToDownload.length) * 100;
        setStatus(`Adding frames to ZIP: ${i + 1}/${framesToDownload.length} (${progress.toFixed(1)}%)`);
      }
      
      setStatus('Generating ZIP file...');
      const content = await zip.generateAsync({ type: 'blob' });
      saveAs(content, filename);
      setStatus(`‚úÖ ZIP download started: ${filename}`);
      showToast(`ZIP file "${filename}" is ready for download!`);
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (frames.length === 0) return;
      
      switch (e.key) {
        case 'ArrowLeft':
          e.preventDefault();
          prevFrame.click();
          break;
        case 'ArrowRight':
          e.preventDefault();
          nextFrame.click();
          break;
        case ' ':
          e.preventDefault();
          if (playerTimer) {
            pausePlayer();
          } else {
            startPlayer();
          }
          break;
        case 'Escape':
          pausePlayer();
          break;
      }
    });

    // Utility functions
    function setStatus(text) {
      statusEl.textContent = text;
    }

    function updatePlayerInfo() {
      const frame = frames[currentIndex];
      const timeStr = frame ? frame.timestamp.toFixed(2) + 's' : '0.00s';
      playerInfo.textContent = `Frames: ${frames.length} ‚Ä¢ Index: ${currentIndex} ‚Ä¢ Time: ${timeStr}`;
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }

    // Initialize
    updatePlayerInfo();

    // Drag and drop functionality
    document.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
    });

    document.addEventListener('drop', (e) => {
      e.preventDefault();
      const files = Array.from(e.dataTransfer.files);
      const videoFile = files.find(f => f.type.startsWith('video/'));
      
      if (videoFile) {
        const dt = new DataTransfer();
        dt.items.add(videoFile);
        fileEl.files = dt.files;
        fileEl.dispatchEvent(new Event('change'));
      }
    });

    // Enhanced canvas context settings for better quality
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';

    // Auto-save settings to localStorage (with fallback for restricted environments)
    function saveSettings() {
      try {
        const settings = {
          fps: fpsEl.value,
          outputFormat: outputFormat.value,
          quality: quality.value,
          scaleFactor: scaleFactor.value,
          playbackFps: playFps.value
        };
        // Only save if localStorage is available
        if (typeof Storage !== 'undefined') {
          localStorage.setItem('videoFrameExtractorSettings', JSON.stringify(settings));
        }
      } catch (e) {
        // Silently fail if localStorage is not available
      }
    }

    function loadSettings() {
      try {
        if (typeof Storage !== 'undefined') {
          const saved = localStorage.getItem('videoFrameExtractorSettings');
          if (saved) {
            const settings = JSON.parse(saved);
            fpsEl.value = settings.fps || 10;
            outputFormat.value = settings.outputFormat || 'png';
            quality.value = settings.quality || 90;
            scaleFactor.value = settings.scaleFactor || 1;
            playFps.value = settings.playbackFps || 12;
            
            // Update displays
            fpsValue.textContent = fpsEl.value;
            qualityValue.textContent = quality.value + '%';
            scaleValue.textContent = scaleFactor.value + 'x';
            playFpsValue.textContent = playFps.value + ' FPS';
          }
        }
      } catch (e) {
        // Silently fail if localStorage is not available
      }
    }

    // Save settings when they change
    [fpsEl, outputFormat, quality, scaleFactor, playFps].forEach(el => {
      el.addEventListener('change', saveSettings);
    });

    // Load settings on startup
    loadSettings();

    // Performance optimization: Use requestAnimationFrame for smooth playback
    let animationId = null;
    
    function smoothPlayer() {
      const fps = Number(playFps.value) || 12;
      const frameTime = 1000 / fps;
      let lastTime = 0;
      
      function animate(currentTime) {
        if (currentTime - lastTime >= frameTime) {
          showFrame((currentIndex + 1) % frames.length);
          lastTime = currentTime;
        }
        
        if (playerTimer) {
          animationId = requestAnimationFrame(animate);
        }
      }
      
      if (frames.length > 0) {
        animationId = requestAnimationFrame(animate);
      }
    }

    // Update player functions to use smooth animation
    function startPlayerSmooth() {
      if (frames.length === 0) return;
      if (playerTimer) return; // Already playing
      
      playerTimer = true; // Use as flag
      smoothPlayer();
    }

    function pausePlayerSmooth() {
      playerTimer = null;
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
    }

    // Replace the original player functions
    playBtn.removeEventListener('click', startPlayer);
    pauseBtn.removeEventListener('click', pausePlayer);
    playBtn.addEventListener('click', startPlayerSmooth);
    pauseBtn.addEventListener('click', pausePlayerSmooth);

    // Add fullscreen preview functionality
    bigPreview.addEventListener('dblclick', () => {
      const img = bigPreview.querySelector('img');
      if (img && img.requestFullscreen) {
        img.requestFullscreen();
      }
    });

    // Add context menu for frame operations
    gallery.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      const thumb = e.target.closest('.thumb');
      if (thumb) {
        const index = Array.from(gallery.children).indexOf(thumb.parentElement);
        showFrameContextMenu(e, index);
      }
    });

    function showFrameContextMenu(e, frameIndex) {
      // Simple context menu implementation
      const menu = document.createElement('div');
      menu.style.position = 'fixed';
      menu.style.left = e.clientX + 'px';
      menu.style.top = e.clientY + 'px';
      menu.style.background = '#1e293b';
      menu.style.border = '1px solid #475569';
      menu.style.borderRadius = '6px';
      menu.style.padding = '8px 0';
      menu.style.zIndex = '1000';
      menu.style.minWidth = '120px';
      
      const options = [
        { text: 'Download', action: () => downloadSingleFrame(frameIndex) },
        { text: 'Copy to clipboard', action: () => copyFrameToClipboard(frameIndex) },
        { text: 'Delete', action: () => deleteFrame(frameIndex) }
      ];
      
      options.forEach(option => {
        const item = document.createElement('div');
        item.textContent = option.text;
        item.style.padding = '8px 16px';
        item.style.cursor = 'pointer';
        item.style.color = '#e2e8f0';
        item.addEventListener('mouseover', () => item.style.background = '#334155');
        item.addEventListener('mouseout', () => item.style.background = 'transparent');
        item.addEventListener('click', () => {
          option.action();
          document.body.removeChild(menu);
        });
        menu.appendChild(item);
      });
      
      document.body.appendChild(menu);
      
      // Close menu on click elsewhere
      setTimeout(() => {
        document.addEventListener('click', () => {
          if (document.body.contains(menu)) {
            document.body.removeChild(menu);
          }
        }, { once: true });
      }, 100);
    }

    function downloadSingleFrame(index) {
      const frame = frames[index];
      if (frame) {
        const link = document.createElement('a');
        link.href = frame.url;
        link.download = frame.name;
        link.click();
      }
    }

    async function copyFrameToClipboard(index) {
      const frame = frames[index];
      if (frame && navigator.clipboard && navigator.clipboard.write) {
        try {
          await navigator.clipboard.write([
            new ClipboardItem({ [frame.blob.type]: frame.blob })
          ]);
          showToast('Frame copied to clipboard!');
        } catch (e) {
          showToast('Failed to copy frame to clipboard');
        }
      }
    }

    function deleteFrame(index) {
      if (frames[index]) {
        URL.revokeObjectURL(frames[index].url);
        frames.splice(index, 1);
        selectedFrames.delete(index);
        
        // Update selected frame indices
        const newSelected = new Set();
        selectedFrames.forEach(idx => {
          if (idx < index) newSelected.add(idx);
          else if (idx > index) newSelected.add(idx - 1);
        });
        selectedFrames = newSelected;
        
        // Rebuild gallery
        gallery.innerHTML = '';
        frames.forEach((frame, idx) => {
          const container = document.createElement('div');
          container.style.position = 'relative';
          
          const img = document.createElement('img');
          img.src = frame.url;
          img.className = 'thumb';
          img.title = `Frame ${idx} ‚Ä¢ ${frame.timestamp.toFixed(2)}s`;
          img.onclick = () => showFrame(idx);
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = selectedFrames.has(idx);
          checkbox.style.position = 'absolute';
          checkbox.style.top = '4px';
          checkbox.style.left = '4px';
          checkbox.style.zIndex = '10';
          checkbox.style.width = '16px';
          checkbox.style.height = '16px';
          checkbox.onchange = (e) => toggleFrameSelection(idx, e.target.checked);
          
          container.appendChild(img);
          container.appendChild(checkbox);
          gallery.appendChild(container);
        });
        
        if (currentIndex >= frames.length) {
          currentIndex = Math.max(0, frames.length - 1);
        }
        if (frames.length > 0) {
          showFrame(currentIndex);
        } else {
          bigPreview.innerHTML = '<div class="preview-placeholder"><div style="font-size: 3rem; margin-bottom: 16px;">üìΩÔ∏è</div><div>Frame preview will appear here</div></div>';
          playBtn.disabled = true;
          pauseBtn.disabled = true;
          downloadZipBtn.disabled = true;
        }
        
        downloadSelected.disabled = selectedFrames.size === 0;
        updatePlayerInfo();
        showToast('Frame deleted');
      }
    }
  </script>
</body>
</html>
